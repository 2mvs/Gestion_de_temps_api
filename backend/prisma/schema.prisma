// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// MODÈLES D'AUTHENTIFICATION
// ============================================

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String @db.VarChar(255)
  role      UserRole @default(UTILISATEUR)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  employee         Employee?
  auditLogs        AuditLog[]
  notifications    Notification[]
  approvedAbsences Absence[]      @relation("ApprovedBy")
  managedUnits     OrganizationalUnit[] @relation("UnitManager")

  @@map("users")
}

enum UserRole {
  ADMINISTRATEUR @map("ADMIN")
  GESTIONNAIRE   @map("MANAGER")
  UTILISATEUR    @map("USER")
}

// ============================================
// MODÈLES EMPLOYÉS ET ORGANISATION
// ============================================

model Employee {
  id             Int       @id @default(autoincrement())
  employeeNumber String    @unique
  firstName      String
  lastName       String
  email          String?
  phone          String?
  gender         Gender    @default(INCONNU)
  hireDate       DateTime
  contractType   ContractType @default(TEMPS_PLEIN)
  status         EmployeeStatus @default(ACTIF)
  
  // Relations
  userId               Int?                  @unique
  user                 User?                 @relation(fields: [userId], references: [id])
  organizationalUnitId Int?
  organizationalUnit   OrganizationalUnit?   @relation(fields: [organizationalUnitId], references: [id])
  workCycleId          Int?
  workCycle            WorkCycle?            @relation(fields: [workCycleId], references: [id])

  // Relations inversées
  timeEntries    TimeEntry[]
  absences       Absence[]
  overtimes      Overtime[]
  specialHours   SpecialHour[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@map("employees")
}

enum Gender {
  HOMME    @map("MALE")
  FEMME    @map("FEMALE")
  INCONNU  @map("UNKNOWN")
}

enum ContractType {
  TEMPS_PLEIN    @map("FULL_TIME")
  TEMPS_PARTIEL  @map("PART_TIME")
  INTERIM
  CONTRAT        @map("CONTRACT")
}

enum EmployeeStatus {
  ACTIF      @map("ACTIVE")
  INACTIF    @map("INACTIVE")
  SUSPENDU   @map("SUSPENDED")
  RESILIE    @map("TERMINATED")
}

model OrganizationalUnit {
  id           Int     @id @default(autoincrement())
  code         String  @unique
  name         String
  description  String? @db.Text
  level        Int     @default(0)
  
  // Hiérarchie
  parentId     Int?
  parent       OrganizationalUnit?  @relation("UnitHierarchy", fields: [parentId], references: [id])
  children     OrganizationalUnit[] @relation("UnitHierarchy")

  // Relations
  employees    Employee[]
  managerId    Int?
  manager      User?   @relation("UnitManager", fields: [managerId], references: [id])
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime?

  @@map("organizational_units")
}

// ============================================
// MODÈLES CYCLES DE TRAVAIL ET HORAIRES
// ============================================

model WorkSchedule {
  id                          Int                 @id @default(autoincrement())
  label                       String
  abbreviation                String?
  startTime                   String              // Format HH:MM
  endTime                     String              // Format HH:MM
  theoreticalDayHours         Float?
  theoreticalMorningHours     Float?
  theoreticalAfternoonHours   Float?

  slots       WorkScheduleSlot[]
  workCycles  WorkCycle[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  deletedAt   DateTime?

  @@map("work_schedules")
}

model WorkScheduleSlot {
  id         Int               @id @default(autoincrement())
  scheduleId Int
  schedule   WorkSchedule      @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  slotType   ScheduleSlotType
  startTime  String            // Format HH:MM
  endTime    String            // Format HH:MM
  label      String?
  multiplier Float             @default(1.0)

  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  @@map("work_schedule_slots")
}

enum ScheduleSlotType {
  FRANCHISE_ENTREE      @map("ENTRY_GRACE")
  PAUSE                 @map("BREAK")
  HEURE_SUPPLEMENTAIRE  @map("OVERTIME")
  HEURE_SPECIALE        @map("SPECIAL")
}

model WorkCycle {
  id           Int           @id @default(autoincrement())
  label        String
  abbreviation String?
  scheduleId   Int
  schedule     WorkSchedule  @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  employees    Employee[]

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  deletedAt    DateTime?

  @@map("work_cycles")
}

// ============================================
// MODÈLES POINTAGES ET TEMPS
// ============================================

model TimeEntry {
  id                Int            @id @default(autoincrement())
  date              DateTime
  clockIn           DateTime?
  clockOut          DateTime?
  totalHours        Float?
  status            TimeEntryStatus @default(EN_ATTENTE)
  
  // Validation
  isValidated       Boolean        @default(false)
  validatedAt       DateTime?
  validationErrors  String?  @db.Text      // JSON des erreurs de validation
  
  // Relations
  employeeId        Int
  employee          Employee       @relation(fields: [employeeId], references: [id])
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@unique([employeeId, date])
  @@map("time_entries")
}

enum TimeEntryStatus {
  EN_ATTENTE  @map("PENDING")
  TERMINE     @map("COMPLETED")
  INCOMPLET   @map("INCOMPLETE")
  ABSENT
}

// ============================================
// MODÈLES ABSENCES ET DEMANDES
// ============================================

model Absence {
  id          Int            @id @default(autoincrement())
  absenceType AbsenceType    @default(CONGES)
  startDate   DateTime
  endDate     DateTime
  days        Float
  reason      String?  @db.Text
  status      ApprovalStatus @default(EN_ATTENTE)
  
  // Relations
  employeeId  Int
  employee    Employee       @relation(fields: [employeeId], references: [id])
  approvedBy  Int?
  approver    User?          @relation("ApprovedBy", fields: [approvedBy], references: [id])
  approvedAt  DateTime?
  
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@map("absences")
}

enum AbsenceType {
  CONGES             @map("VACATION")
  CONGE_MALADIE      @map("SICK_LEAVE")
  PERSONNEL          @map("PERSONAL")
  MATERNITE          @map("MATERNITY")
  PATERNITE          @map("PATERNITY")
  SANS_SOLDE         @map("UNPAID_LEAVE")
  AUTRE              @map("OTHER")
}

model Overtime {
  id          Int            @id @default(autoincrement())
  date        DateTime
  hours       Float
  reason      String?  @db.Text
  status      ApprovalStatus @default(EN_ATTENTE)
  
  // Relations
  employeeId  Int
  employee    Employee       @relation(fields: [employeeId], references: [id])
  approvedAt  DateTime?
  
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@map("overtimes")
}

model SpecialHour {
  id          Int            @id @default(autoincrement())
  date        DateTime
  hours       Float
  hourType    SpecialHourType @default(FERIE)
  reason      String?  @db.Text
  status      ApprovalStatus @default(EN_ATTENTE)
  
  // Relations
  employeeId  Int
  employee    Employee       @relation(fields: [employeeId], references: [id])
  approvedAt  DateTime?
  
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@map("special_hours")
}

enum SpecialHourType {
  FERIE      @map("HOLIDAY")
  NUIT       @map("NIGHT_SHIFT")
  WEEKEND
  ASTREINTE  @map("ON_CALL")
}

enum ApprovalStatus {
  EN_ATTENTE  @map("PENDING")
  APPROUVE    @map("APPROVED")
  REJETE      @map("REJECTED")
}

// ============================================
// MODÈLES NOTIFICATIONS ET AUDIT
// ============================================

model Notification {
  id        Int                @id @default(autoincrement())
  type      NotificationType   @default(INFORMATION)
  title     String
  message   String  @db.Text
  isRead    Boolean            @default(false)
  
  // Relations
  userId    Int
  user      User               @relation(fields: [userId], references: [id])
  
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  @@map("notifications")
}

enum NotificationType {
  INFORMATION        @map("INFO")
  ALERTE             @map("WARNING")
  ERREUR             @map("ERROR")
  SUCCES             @map("SUCCESS")
  DEMANDE_APPROBATION @map("APPROVAL_REQUEST")
  ALERTE_SYSTEME     @map("SYSTEM_ALERT")
}

model AuditLog {
  id          Int      @id @default(autoincrement())
  action      String
  modelType   String
  modelId     Int?
  oldValue    String?  @db.Text  // JSON
  newValue    String?  @db.Text  // JSON
  ipAddress   String?
  userAgent   String?  @db.Text
  
  // Relations
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  
  createdAt   DateTime @default(now())

  @@map("audit_logs")
}

